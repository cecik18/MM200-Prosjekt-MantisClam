<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="page1_stylesheet_Cecilia_Versjon3.css">
    <title>Login page</title>
</head>

<body>

  <div class="grid-container">
      <div id="taskPlannerHeader">MantisClam Taskplanner</div>

      <div id="taskPlannerLogin">Sign in
        <form id="loginForm">
            <input id="loginEmail" type="email" placeholder="Email"/>
            <br>
            <input id="loginPassword" type="password" placeholder="Password" />
            <br>
            <button id="loginBTN" type="submit">Sign in</button>
            <label id="loginId"></label>
          </form>
      </div>
      <div id="taskPlannerCreate">Sign up
        <form id="CreateForm">
            <input id="createEmail" type="email" placeholder="Email"/>
            <br>
            <input id="createPassword" type="password" placeholder="Password" />
            <br>
            <button id="createBTN" type="submit">Create new user</button>
            <label id="createId"></label>
          </form>
      </div>
  </div>

    
</body>

<script>

    //Login -------------------------------------------------------------------------------------------------------------------------------------

        sessionStorage.removeItem("userData")
        sessionStorage.removeItem("listData")
        sessionStorage.removeItem("itemData")

        const emailLogin = document.getElementById("loginEmail");
        const passwordLogin = document.getElementById("loginPassword");

        let credentials = null;

       loginForm.onsubmit = submit;

        async function submit (evt) {

            try {
        
            //Hindrer form fra å submittes
            evt.preventDefault();

            let username = emailLogin.value
            let password = passwordLogin.value

            //Brukernavn og passord blir omkodet til noe annet
            credentials = "Basic " + window.btoa(`${username}:${password}`) 

            let config = {
                method: "GET",
                headers: {
                    "content-type": "application/json",
                    "authorization": credentials
                }
            }

            //Lagrer userid og går til page 2 om login blir godkjent
                let response = await fetch(`/user`, config)
                console.log(response.status);
                let data = await response.json();
                console.log(data);

                //lagrer data i sessionstorage (sessionstorage fungerer likt som localstorage, men dataen blir slettet etter nettleser lukkes)
                let jsontext = JSON.stringify(data);
                sessionStorage.setItem("userData", jsontext);

                
                //henter fra sessionstorage
                jsontext = sessionStorage.getItem("userData");
                let userData = JSON.parse(jsontext);
                console.log(userData);

                let userid = userData.userid;

                response = await fetch(`/list/${userid}`, config)
                console.log(response.status);
                data = await response.json();
                console.log(data);

                jsontext = JSON.stringify(data);
                sessionStorage.setItem("listData", jsontext);

                location.href="page2_Cecilia_Versjon4_AddAndDelete.html"
            
            } catch (error) {
                console.error(error)
            }
        }

// ------------------------------------------------------------------------------------------------------------------------------------------------

//Create ------------------------------------------------------------------------------------------------------------------------------------
    
        const emailInput = document.getElementById("createEmail");
        const passwordInput = document.getElementById("createPassword");

        document.getElementById("createBTN").onclick = function (evt) {
            
            evt.preventDefault();

            if (emailInput.value.length < 3 && passwordInput.value.length < 3) {
                alert("At least 3 characters.");
                return
            }

            let body = {
                username: emailInput.value,
                password: passwordInput.value
            }
            let config = {
                method: "POST",
                headers: {
                    "content-type": "application/json",
                    "authorization": credentials
                },
                body: JSON.stringify(body)
            }

            fetch("/user", config).then(resp => {
                console.log(resp.status);
                if (resp.status === 409){
                    alert("User already exists!")
                }
            })


        }

// ---------------------------------------------------------------------------------------------------------------------------------------------------------------------

</script>


</html>
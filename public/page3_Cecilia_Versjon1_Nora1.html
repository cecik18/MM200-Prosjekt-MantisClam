<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="page3_stylesheet_Cecilia_Versjon1.css">
    <title>Page of list items</title>
</head>

<body>

  <div class="grid-container">
    <div id="taskPlannerMenu">
        <button onclick="returnHome()" id="previousPageButton">Return</button>
        <button id="signOutButton">Sign out</button>
        <button id="deleteUserButton">Delete user</button>
    </div>
    <div id="taskPlannerHeader_page3">
      <p id="headerTitle">MantisClam Taskplanner</p>
      <p id="titleOfList">Huskeliste</p>
    </div>
    <div id="createNewListItem">
    
      <input id="newListItemInput" placeholder="New list item...">
      <!--
      <button id="addListItemButton">Add list item</button>
      -->
      <button onclick="NewListItem()" class="addListItemButton" id="addListItemButton">Add list item</button>

      <button onclick="saveChanges()" class="addListItemButton" id="addListItemButton">Save and exit</button>

    </div>
  
    <div id="allYourListItems">
      <ul id="listOfListItems">
          <div id="loadedItems">
              
          </div>

      </ul>
    </div>
  </div>
    
<script>
  // localStorage.getItem("LastList") selects actual list to manipulate item
  // Let LastList= 
  
  // Array of items

  //STIAN_________________________________________________________________________________________________________________________________________________________

    
        //henter fra sessionstorage
        let jsontext = sessionStorage.getItem("userData");
        let userData = JSON.parse(jsontext);
        console.log(userData);
        let credentials = null;

        //henter fra sessionstorage
        jsontext = sessionStorage.getItem("listData");
        let listData = JSON.parse(jsontext);
        console.log(listData);

        //henter fra sessionstorage
        jsontext = sessionStorage.getItem("itemData");
        let itemData = JSON.parse(jsontext);
        console.log(itemData);
  
        let newListItemInput = document.getElementById("newListItemInput");
    // ________________________________________________________________________________________________________________________________________________________


    let tasks = [];
    let index = 0;

  // Create a new list item
  function NewListItem() {
    let li = document.createElement("li");
    let inputValue = document.getElementById("newListItemInput").value;
    let t = document.createTextNode(inputValue);
    let htmlDelete = '<button id="' + index + '" class="deleteListItemButton">Delete list item</button>';  //legger til delete knapp
    li.innerHTML = htmlDelete;                                                          // ---------------------
    li.appendChild(t);
    if (inputValue === '') {
      alert("You should write an item");
    } else {
      document.getElementById("listOfListItems").appendChild(li);
      tasks.push({listCont: inputValue});
      console.log(tasks)
      index++;
    }
    document.getElementById("newListItemInput").value = "";
  
    var close = document.getElementsByClassName("deleteListItemButton");
    for (i = 0; i < close.length; i++) {
        let remove = [];
      close[i].onclick = function(evt) {
        let div = this.parentElement;
        let target = evt.target.id;
        tasks.splice(target, 1, "OBJECT DELETED");
        console.log(tasks.length);
        console.log(tasks);
        index--;
        div.style.display = "none";
      }
    }
    return tasks;
  }

  function saveChanges() {
      let check = tasks.indexOf("OBJECT DELETED");
      while (check > -1) {
          tasks.splice(check, 1)
          check = tasks.indexOf("OBJECT DELETED");
      }

        let jsontext = JSON.stringify(tasks);
        sessionStorage.setItem("itemData", jsontext);

        updateListCont();

        location.href="page2_Cecilia_Versjon4.html";
  }

  
  storedItems();
  async function storedItems() {
            try{

            jsontext = sessionStorage.getItem("itemData");
            itemData = JSON.parse(jsontext);
            console.log(itemData);
            let items = itemData;

            for (let item of items) {

            let li = document.createElement("li");
            let inputValue = item.listCont;
            let t = document.createTextNode(inputValue);
            let htmlDelete = '<button id="' + index + '" class="deleteListItemButton">Delete list item</button>'; 
            li.innerHTML = htmlDelete;      
            li.appendChild(t);
            document.getElementById("listOfListItems").appendChild(li);
            tasks.push({listCont: inputValue});
            console.log(tasks)
            index++;
            }
  
            var close = document.getElementsByClassName("deleteListItemButton");
            for (i = 0; i < close.length; i++) {
                let remove = [];
              close[i].onclick = function(evt) {
                let div = this.parentElement;
                let target = evt.target.id;
                tasks.splice(target, 1, "OBJECT DELETED");
                console.log(tasks.length);
                console.log(tasks);
                index--;
                div.style.display = "none";
        }
    }
    return tasks;
        } 
    catch(err){
        console.log(err);
    }
}


  //legger ting allerede i db inn p책 appen
  loadData();
  async function loadData() {
       try {

            let userid = userData.userid;
            let listid = listData[0].listid;

            let config = {
                method: "GET",
                headers: {
                    "content-type": "application/json",
                    "authorization": credentials
                }
            }

                let response = await fetch(`/listUpdate/${listid}/${userid}`, config)
                console.log(response.status);
                let data = await response.json();
                console.log(data);

                let jsontext = JSON.stringify(data);
                sessionStorage.setItem("itemData", jsontext);
            
            } catch (error) {
                console.error(error)
            }
  }

  //STIAN______________________________________________________________________________________________________________________________________
  async function updateListCont() {
      let listid = listData[0].listid; //her m책 endres til 책 f책 listid fra page 2

      console.log(listid)
            try {
                
            for (let item of itemData ) {
            let body = {
                userid: userData.userid,
                listid:  listid,
                listCont: item.listCont
            }
            let config = {
                method: "POST",
                headers: {
                    "content-type": "application/json",
                    "authorization": credentials
                },
                body: JSON.stringify(body)
            }

            fetch("/listUpdate", config).then(resp => {
                console.log(resp.status);
            })

        }

            } catch (error) {
                console.error(error);
            }
        }

        
        //sign out------------------------------------------------------------------------------------------------------------
        document.getElementById("signOutButton").onclick = function (evt) {
          
            sessionStorage.removeItem("userData");
            sessionStorage.removeItem("listData");
            sessionStorage.removeItem("itemData");

            location.href = "index.html";
        }
        //-------------------------------------------------------------------------------------------------------------

        //Delete user
        document.getElementById("deleteUserButton").onclick = async function (evt) {

        try {
      
        let confirmation = prompt('Confirm action by typing: "DELETE USER"');
        console.log(confirmation);

        if (confirmation === "DELETE USER") {
          
          let body = {
                username: userData.username,
                userid: userData.userid
            }
            let config = {
                method: "POST",
                headers: {
                    "content-type": "application/json",
                    "authorization": credentials
                },
                body: JSON.stringify(body)
            }
            console.log(config);

            fetch("/deleteUser", config).then(resp => {
                console.log(resp.status);
            })
            sessionStorage.removeItem("userData");
            sessionStorage.removeItem("listData");
            sessionStorage.removeItem("itemData");
            location.href="index.html"
        }

        } catch (error) {
            console.error(error)
        }
      }

      function returnHome() {
          location.href="page2_Cecilia_Versjon4.html";
      }


//__________________________________________________________________________________________________________________________________________________________





</script>


</body>


</html>